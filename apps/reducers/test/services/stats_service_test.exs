defmodule Service.StatsTest do
  use ExUnit.Case
  doctest Service.Stats

  alias Reducer.State

  setup_all _context do
    {:ok, [
      apa_event: %DB.Event{
        domain: "stats",
        entity_id: "81bc429d-d055-4002-a64f-59e1af501236",
        event_id: "9c49b546-6336-11e7-bbc6-4de700000259",
        kv: "dev_events/9c49b546-6336-11e7-bbc6-4de700000259",
        kv_time: "2017-07-07T17=>06=>25.954951Z",
        meta: %{"store" => "2",
        "data" =>
          %{"season1preseason" => [%{"Goal" => "150", "UPH" => "14.0",
                 "challenge_type" => "footwear", "complete_units" => "76.0",
                 "start_date" => "2017-06-17", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "150.0",
                 "challenge_type" => "footwear", "complete_units" => "270.0",
                 "start_date" => "2017-06-18", "store_id" => "2"},
               %{"Goal" => "250", "UPH" => "420.0",
                 "challenge_type" => "equipment", "complete_units" => "72.0",
                 "start_date" => "2017-06-18", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "27.0",
                 "challenge_type" => "footwear", "complete_units" => "150.0",
                 "start_date" => "2017-06-17", "store_id" => "2"}],
              "season1week1" => [%{"Goal" => "90", "UPH" => "55.0",
                 "challenge_type" => "apparel", "complete_units" => "75.0",
                 "start_date" => "2017-06-19", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "84.0",
                 "challenge_type" => "footwear", "complete_units" => "70.0",
                 "start_date" => "2017-06-20", "store_id" => "2"},
               %{"Goal" => "250", "UPH" => "207.0",
                 "challenge_type" => "equipment", "complete_units" => "53.0",
                 "start_date" => "2017-06-21", "store_id" => "2"},
               %{"Goal" => "125", "UPH" => "107.0", "challenge_type" => "cph",
                 "complete_units" => "42.0", "start_date" => "2017-06-21",
                 "store_id" => "2"},
               %{"Goal" => "90", "UPH" => "99.0", "challenge_type" => "apparel",
                 "complete_units" => "125.0", "start_date" => "2017-06-21",
                 "store_id" => "2"},
               %{"Goal" => "125", "UPH" => "105.0", "challenge_type" => "cph",
                 "complete_units" => "101.0", "start_date" => "2017-06-22",
                 "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "264.0",
                 "challenge_type" => "footwear", "complete_units" => "163.0",
                 "start_date" => "2017-06-23", "store_id" => "2"},
               %{"Goal" => "90", "UPH" => "59.0", "challenge_type" => "apparel",
                 "complete_units" => "90.0", "start_date" => "2017-06-23",
                 "store_id" => "2"},
               %{"Goal" => "125", "UPH" => "107.0", "challenge_type" => "cph",
                 "complete_units" => "42.0", "start_date" => "2017-06-21",
                 "store_id" => "2"},
               %{"Goal" => "125", "UPH" => "105.0", "challenge_type" => "cph",
                 "complete_units" => "101.0", "start_date" => "2017-06-22",
                 "store_id" => "2"},
               %{"Goal" => "100", "UPH" => "260.0",
                 "challenge_type" => "product refill",
                 "complete_units" => "90.0", "start_date" => "2017-06-21",
                 "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "310.0",
                 "challenge_type" => "footwear", "complete_units" => "96.0",
                 "start_date" => "2017-06-20", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "125.0",
                 "challenge_type" => "footwear", "complete_units" => "84.0",
                 "start_date" => "2017-06-20", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "175.0",
                 "challenge_type" => "footwear", "complete_units" => "72.0",
                 "start_date" => "2017-06-20", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "183.0",
                 "challenge_type" => "footwear", "complete_units" => "96.0",
                 "start_date" => "2017-06-20", "store_id" => "2"},
               %{"Goal" => "125", "UPH" => "242.0", "challenge_type" => "cph",
                 "complete_units" => "16.0", "start_date" => "2017-06-22",
                 "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "173.0",
                 "challenge_type" => "footwear", "complete_units" => "227.0",
                 "start_date" => "2017-06-23", "store_id" => "2"},
               %{"Goal" => "100", "UPH" => "269.0",
                 "challenge_type" => "product refill",
                 "complete_units" => "100.0", "start_date" => "2017-06-21",
                 "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "61.0",
                 "challenge_type" => "footwear", "complete_units" => "136.0",
                 "start_date" => "2017-06-19", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "94.0",
                 "challenge_type" => "footwear", "complete_units" => "140.0",
                 "start_date" => "2017-06-21", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "70.0",
                 "challenge_type" => "footwear", "complete_units" => "68.0",
                 "start_date" => "2017-06-22", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "136.0",
                 "challenge_type" => "footwear", "complete_units" => "50.0",
                 "start_date" => "2017-06-21", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "101.0",
                 "challenge_type" => "footwear", "complete_units" => "72.0",
                 "start_date" => "2017-06-21", "store_id" => "2"},
               %{"Goal" => "125", "UPH" => "107.0", "challenge_type" => "cph",
                 "complete_units" => "42.0", "start_date" => "2017-06-21",
                 "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "227.0",
                 "challenge_type" => "footwear", "complete_units" => "75.0",
                 "start_date" => "2017-06-22", "store_id" => "2"},
               %{"Goal" => "125", "UPH" => "105.0", "challenge_type" => "cph",
                 "complete_units" => "101.0", "start_date" => "2017-06-22",
                 "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "157.0",
                 "challenge_type" => "footwear", "complete_units" => "78.0",
                 "start_date" => "2017-06-23", "store_id" => "2"}],
              "season1week2" => [%{"Goal" => "125", "UPH" => "111.0",
                 "challenge_type" => "cph", "complete_units" => "111.0",
                 "start_date" => "2017-06-27", "store_id" => "2"},
               %{"Goal" => "100", "UPH" => "117.0",
                 "challenge_type" => "product refill",
                 "complete_units" => "75.0", "start_date" => "2017-06-26",
                 "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "269.0",
                 "challenge_type" => "footwear", "complete_units" => "115.0",
                 "start_date" => "2017-06-26", "store_id" => "2"},
               %{"Goal" => "100", "UPH" => "131.0",
                 "challenge_type" => "product refill",
                 "complete_units" => "55.0", "start_date" => "2017-06-27",
                 "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "137.0",
                 "challenge_type" => "footwear", "complete_units" => "60.0",
                 "start_date" => "2017-06-27", "store_id" => "2"},
               %{"Goal" => "90", "UPH" => "91.0", "challenge_type" => "apparel",
                 "complete_units" => "25.0", "start_date" => "2017-06-27",
                 "store_id" => "2"},
               %{"Goal" => "125", "UPH" => "184.0", "challenge_type" => "cph",
                 "complete_units" => "13.0", "start_date" => "2017-06-27",
                 "store_id" => "2"},
               %{"Goal" => "90", "UPH" => "114.0",
                 "challenge_type" => "apparel", "complete_units" => "50.0",
                 "start_date" => "2017-06-27", "store_id" => "2"},
               %{"Goal" => "125", "UPH" => "111.0", "challenge_type" => "cph",
                 "complete_units" => "111.0", "start_date" => "2017-06-27",
                 "store_id" => "2"},
               %{"Goal" => "100", "UPH" => "261.0",
                 "challenge_type" => "product refill",
                 "complete_units" => "267.0", "start_date" => "2017-07-01",
                 "store_id" => "2"},
               %{"Goal" => "90", "UPH" => "78.0", "challenge_type" => "apparel",
                 "complete_units" => "90.0", "start_date" => "2017-06-26",
                 "store_id" => "2"},
               %{"Goal" => "90", "UPH" => "156.0",
                 "challenge_type" => "apparel", "complete_units" => "54.0",
                 "start_date" => "2017-06-26", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "82.0",
                 "challenge_type" => "footwear", "complete_units" => "87.0",
                 "start_date" => "2017-06-27", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "115.0",
                 "challenge_type" => "footwear", "complete_units" => "116.0",
                 "start_date" => "2017-06-27", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "464.0",
                 "challenge_type" => "footwear", "complete_units" => "107.0",
                 "start_date" => "2017-06-27", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "365.0",
                 "challenge_type" => "footwear", "complete_units" => "87.0",
                 "start_date" => "2017-06-27", "store_id" => "2"},
               %{"Goal" => "100", "UPH" => "175.0",
                 "challenge_type" => "product refill",
                 "complete_units" => "263.0", "start_date" => "2017-06-25",
                 "store_id" => "2"},
               %{"Goal" => "100", "UPH" => "126.0",
                 "challenge_type" => "product refill",
                 "complete_units" => "128.0", "start_date" => "2017-06-25",
                 "store_id" => "2"}],
              "season1week3" => [%{"Goal" => "90", "UPH" => "1.0",
                 "challenge_type" => "apparel", "complete_units" => "90.0",
                 "start_date" => "2017-07-04", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "130.0",
                 "challenge_type" => "footwear", "complete_units" => "150.0",
                 "start_date" => "2017-07-07", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "112.0",
                 "challenge_type" => "footwear", "complete_units" => "100.0",
                 "start_date" => "2017-07-07", "store_id" => "2"},
               %{"Goal" => "90", "UPH" => "121.0",
                 "challenge_type" => "apparel", "complete_units" => "90.0",
                 "start_date" => "2017-07-05", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "64.0",
                 "challenge_type" => "footwear", "complete_units" => "86.0",
                 "start_date" => "2017-07-07", "store_id" => "2"},
               %{"Goal" => "90", "UPH" => "222.0",
                 "challenge_type" => "apparel", "complete_units" => "75.0",
                 "start_date" => "2017-07-02", "store_id" => "2"},
               %{"Goal" => "250", "UPH" => "283.0",
                 "challenge_type" => "equipment", "complete_units" => "282.0",
                 "start_date" => "2017-07-02", "store_id" => "2"},
               %{"Goal" => "250", "UPH" => "2.0",
                 "challenge_type" => "equipment", "complete_units" => "250.0",
                 "start_date" => "2017-07-02", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "30.0",
                 "challenge_type" => "footwear", "complete_units" => "100.0",
                 "start_date" => "2017-07-06", "store_id" => "2"},
               %{"Goal" => "90", "UPH" => "54.0", "challenge_type" => "apparel",
                 "complete_units" => "60.0", "start_date" => "2017-07-05",
                 "store_id" => "2"},
               %{"Goal" => "90", "UPH" => "100.0",
                 "challenge_type" => "apparel", "complete_units" => "90.0",
                 "start_date" => "2017-07-05", "store_id" => "2"},
               %{"Goal" => "125", "UPH" => "83.0", "challenge_type" => "cph",
                 "complete_units" => "108.0", "start_date" => "2017-07-05",
                 "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "181.0",
                 "challenge_type" => "footwear", "complete_units" => "150.0",
                 "start_date" => "2017-07-06", "store_id" => "2"},
               %{"Goal" => "100", "UPH" => "136.0",
                 "challenge_type" => "product refill",
                 "complete_units" => "23.0", "start_date" => "2017-07-03",
                 "store_id" => "2"},
               %{"Goal" => "100", "UPH" => "156.0",
                 "challenge_type" => "product refill",
                 "complete_units" => "37.0", "start_date" => "2017-07-03",
                 "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "111.0",
                 "challenge_type" => "footwear", "complete_units" => "90.0",
                 "start_date" => "2017-07-05", "store_id" => "2"},
               %{"Goal" => "100", "UPH" => "109.0",
                 "challenge_type" => "product refill",
                 "complete_units" => "160.0", "start_date" => "2017-07-03",
                 "store_id" => "2"},
               %{"Goal" => "90", "UPH" => "164.0",
                 "challenge_type" => "apparel", "complete_units" => "250.0",
                 "start_date" => "2017-07-02", "store_id" => "2"},
               %{"Goal" => "150", "UPH" => "2.0",
                 "challenge_type" => "footwear", "complete_units" => "150.0",
                 "start_date" => "2017-07-04", "store_id" => "2"},
               %{"Goal" => "100", "UPH" => "58.0",
                 "challenge_type" => "product refill",
                 "complete_units" => "60.0", "start_date" => "2017-07-06",
                 "store_id" => "2"}]}},
        parents: "",
        realm: "nike",
        remote_ip: "127.0.0.1",
        type: "challenge"
      },
      actuals_per_store: %DB.Event{
        domain: "stats",
        entity_id: "81bc429d-d055-4002-a64f-59e1af501236",
        event_id: "5a0c95a6-6334-11e7-92f2-4de700000259",
        kv: "dev_events/5a0c95a6-6334-11e7-92f2-4de700000259",
        kv_time: "2017-07-07T16=>50=>15.831287Z",
        meta: %{"store" => "2", "data"=>%{"season1preseason" => [%{"Count" => "1184",
                 "Metrics" => "Actual Units Sold", "Store" => "2",
                 "Week" => "2017-06-17"},
               %{"Count" => "1027", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-18"}],
              "season1week1" => [%{"Count" => "1165",
                 "Metrics" => "Actual Receipts", "Store" => "2",
                 "Week" => "2017-06-19"},
               %{"Count" => "326", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-19"},
               %{"Count" => "780", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-20"},
               %{"Count" => "392", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-20"},
               %{"Count" => "1315", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-21"},
               %{"Count" => "271", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-21"},
               %{"Count" => "1114", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-22"},
               %{"Count" => "914.00", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-23"},
               %{"Count" => "623", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-23"},
               %{"Count" => "1029", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-24"}],
              "season1week2" => [%{"Count" => "1041",
                 "Metrics" => "Actual Units Sold", "Store" => "2",
                 "Week" => "2017-06-25"},
               %{"Count" => "1391", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-26"},
               %{"Count" => "1342", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-27"},
               %{"Count" => "765", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-28"},
               %{"Count" => "280", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-26"},
               %{"Count" => "273", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-27"},
               %{"Count" => "306", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-28"},
               %{"Count" => "1259", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-29"},
               %{"Count" => "329", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-29"},
               %{"Count" => "1833", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-30"},
               %{"Count" => "649", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-30"},
               %{"Count" => "1082", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-07-01"}],
              "season1week3" => [%{"Count" => "2995",
                 "Metrics" => "Actual Receipts", "Store" => "2",
                 "Week" => "2017-07-03"},
               %{"Count" => "995", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-07-02"},
               %{"Count" => "806", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-07-03"},
               %{"Count" => "2223", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-07-05"},
               %{"Count" => "684", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-07-04"},
               %{"Count" => "292", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-07-05"},
               %{"Count" => "2514", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-07-06"},
               %{"Count" => "889", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-07-06"}]}},
        parents: "",
        realm: "nike",
        remote_ip: "127.0.0.1",
        type: "actuals"
      },
      actuals_per_store_need_bin: %DB.Event{
        domain: "stats",
        entity_id: "81bc429d-d055-4002-a64f-59e1af501236",
        event_id: "5a0c95a6-6334-11e7-92f2-4de700000259",
        kv: "dev_events/5a0c95a6-6334-11e7-92f2-4de700000259",
        kv_time: "2017-07-07T16=>50=>15.831287Z",
        meta: %{"store" => "4", "data"=>%{"season1preseason" => [%{"Count" => "1184",
                 "Metrics" => "Actual Units Sold", "Store" => "2",
                 "Week" => "2017-06-17"},
               %{"Count" => "1027", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-18"}],
              "season1week1" => [%{"Count" => "1165",
                 "Metrics" => "Actual Receipts", "Store" => "2",
                 "Week" => "2017-06-19"},
               %{"Count" => "326", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-19"},
               %{"Count" => "780", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-20"},
               %{"Count" => "392", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-20"},
               %{"Count" => "1315", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-21"},
               %{"Count" => "271", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-21"},
               %{"Count" => "1114", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-22"},
               %{"Count" => "914.00", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-23"},
               %{"Count" => "623", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-23"},
               %{"Count" => "1029", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-24"}],
              "season1week2" => [%{"Count" => "1041",
                 "Metrics" => "Actual Units Sold", "Store" => "2",
                 "Week" => "2017-06-25"},
               %{"Count" => "1391", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-26"},
               %{"Count" => "1342", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-27"},
               %{"Count" => "765", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-28"},
               %{"Count" => "280", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-26"},
               %{"Count" => "273", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-27"},
               %{"Count" => "306", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-28"},
               %{"Count" => "1259", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-29"},
               %{"Count" => "329", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-29"},
               %{"Count" => "1833", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-06-30"},
               %{"Count" => "649", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-06-30"},
               %{"Count" => "1082", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-07-01"}],
              "season1week3" => [%{"Count" => "2995",
                 "Metrics" => "Actual Receipts", "Store" => "2",
                 "Week" => "2017-07-03"},
               %{"Count" => "995", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-07-02"},
               %{"Count" => "806", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-07-03"},
               %{"Count" => "2223", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-07-05"},
               %{"Count" => "684", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-07-04"},
               %{"Count" => "292", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-07-05"},
               %{"Count" => "2514", "Metrics" => "Actual Receipts",
                 "Store" => "2", "Week" => "2017-07-06"},
               %{"Count" => "889", "Metrics" => "Actual Units Sold",
                 "Store" => "2", "Week" => "2017-07-06"}]}},
        parents: "",
        realm: "nike",
        remote_ip: "127.0.0.1",
        type: "actuals"
      },
      reduced_actuals_per_store: %DB.Event{
        domain: "stats",
        entity_id: "81bc429d-d055-4002-a64f-59e1af501236",
        event_id: "5a0c95a6-6334-11e7-92f2-4de700000259",
        kv: "dev_events/5a0c95a6-6334-11e7-92f2-4de700000259",
        kv_time: "2017-07-07T16=>50=>15.831287Z",
        meta: %{"store" => "297", "data"=>%{"season1preseason" => [%{"Count" => "1184",
                 "Metrics" => "Actual Units Sold", "Store" => "297",
                 "Week" => "2017-06-17"},
               %{"Count" => "1027", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-06-18"}],
              "season1week1" => [%{"Count" => "1165",
                 "Metrics" => "Actual Receipts", "Store" => "297",
                 "Week" => "2017-06-19"},
               %{"Count" => "326", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-06-19"},
               %{"Count" => "780", "Metrics" => "Actual Receipts",
                 "Store" => "297", "Week" => "2017-06-20"},
               %{"Count" => "392", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-06-20"},
               %{"Count" => "1315", "Metrics" => "Actual Receipts",
                 "Store" => "297", "Week" => "2017-06-21"},
               %{"Count" => "271", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-06-21"},
               %{"Count" => "1114", "Metrics" => "Actual Receipts",
                 "Store" => "297", "Week" => "2017-06-22"},
               %{"Count" => "914.00", "Metrics" => "Actual Receipts",
                 "Store" => "297", "Week" => "2017-06-23"},
               %{"Count" => "623", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-06-23"},
               %{"Count" => "1029", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-06-24"}],
              "season1week2" => [%{"Count" => "1041",
                 "Metrics" => "Actual Units Sold", "Store" => "297",
                 "Week" => "2017-06-25"},
               %{"Count" => "1391", "Metrics" => "Actual Receipts",
                 "Store" => "297", "Week" => "2017-06-26"},
               %{"Count" => "1342", "Metrics" => "Actual Receipts",
                 "Store" => "297", "Week" => "2017-06-27"},
               %{"Count" => "765", "Metrics" => "Actual Receipts",
                 "Store" => "297", "Week" => "2017-06-28"},
               %{"Count" => "280", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-06-26"},
               %{"Count" => "273", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-06-27"},
               %{"Count" => "306", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-06-28"},
               %{"Count" => "1259", "Metrics" => "Actual Receipts",
                 "Store" => "297", "Week" => "2017-06-29"},
               %{"Count" => "329", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-06-29"},
               %{"Count" => "1833", "Metrics" => "Actual Receipts",
                 "Store" => "297", "Week" => "2017-06-30"},
               %{"Count" => "649", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-06-30"},
               %{"Count" => "1082", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-07-01"}],
              "season1week3" => [%{"Count" => "2995",
                 "Metrics" => "Actual Receipts", "Store" => "297",
                 "Week" => "2017-07-03"},
               %{"Count" => "995", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-07-02"},
               %{"Count" => "806", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-07-03"},
               %{"Count" => "2223", "Metrics" => "Actual Receipts",
                 "Store" => "297", "Week" => "2017-07-05"},
               %{"Count" => "684", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-07-04"},
               %{"Count" => "292", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-07-05"},
               %{"Count" => "2514", "Metrics" => "Actual Receipts",
                 "Store" => "297", "Week" => "2017-07-06"},
               %{"Count" => "889", "Metrics" => "Actual Units Sold",
                 "Store" => "297", "Week" => "2017-07-06"}]}},
        parents: "",
        realm: "nike",
        remote_ip: "127.0.0.1",
        type: "actuals"
      },
      bin_audit_per_store: %DB.Event{domain: "stats", entity_id: "81bc429d-d055-4002-a64f-59e1af501236",
       event_id: "13cbdab4-6331-11e7-80ab-4de700000259",
       kv: "dev_events/13cbdab4-6331-11e7-80ab-4de700000259",
       kv_time: "2017-07-07T16:26:49.476370Z",
       meta: %{"store" => "2", "data" => %{"season1week1" => [%{"BIN_COUNT_TOTAL" => "20",
                 "BIN_PERCENTAGE" => "65.0", "DATE" => "2017-06-21",
                 "Dimension" => "Factory", "District" => "FS21",
                 "NO_OF_AUDITS_PERFORMED" => "1", "PASSED_BIN_COUNT" => "13",
                 "STORE" => "2", "Store Name" => "Commerce",
                 "Territory" => "Southeast", "UPH Standard" => "Factory EAS",
                 "_BATCH_ID_" => "19",
                 "_BATCH_LAST_RUN_" => "2017-06-26T18:05:05",
                 "store_id" => "2"},
                 %{"BIN_COUNT_TOTAL" => "20",
                           "BIN_PERCENTAGE" => "100.0", "DATE" => "2017-06-21",
                           "Dimension" => "Factory", "District" => "FS21",
                           "NO_OF_AUDITS_PERFORMED" => "1", "PASSED_BIN_COUNT" => "13",
                           "STORE" => "2", "Store Name" => "Commerce",
                           "Territory" => "Southeast", "UPH Standard" => "Factory EAS",
                           "_BATCH_ID_" => "19",
                           "_BATCH_LAST_RUN_" => "2017-06-26T18:05:05",
                           "store_id" => "2"}],
              "season1week2" => [%{"BIN_COUNT_TOTAL" => "20",
                 "BIN_PERCENTAGE" => "75.0", "DATE" => "2017-06-27",
                 "Dimension" => "Factory", "District" => "FS21",
                 "NO_OF_AUDITS_PERFORMED" => "1", "PASSED_BIN_COUNT" => "15",
                 "STORE" => "2", "Store Name" => "Commerce",
                 "Territory" => "Southeast", "UPH Standard" => "Factory EAS",
                 "_BATCH_ID_" => "20",
                 "_BATCH_LAST_RUN_" => "2017-07-05T21:07:49",
                 "store_id" => "2"}]}},
       parents: "", realm: "nike", remote_ip: "127.0.0.1", type: "bin_audit"},
    model_after_actuals: %{
      "season1preseason" => %{"refill" => %{"actual_units" => 2211.0} , "weekly_total" => 0},
      "season1week1" => %{"pre" => %{"actual_units" => 5288.0}, "refill" => %{"actual_units" => 2641.0} , "weekly_total" => 0},
      "season1week2" => %{"pre" => %{"actual_units" => 6590.0}, "refill" => %{"actual_units" => 3960.0} , "weekly_total" => 0},
      "season1week3" => %{"pre" => %{"actual_units" => 7732.0}, "refill" => %{"actual_units" => 3666.0}, "weekly_total" => 0 }},
    model_after_challenge: %{
      "season1preseason" => %{"weekly_total" => 0, "pre" => %{"pre_percentage" => 0.7383333333333334, "pre_score" => 0, "units" => 568.0}},
      "season1week1" => %{
         "pre" => %{"pre_percentage" => 0.9774814814814816, "pre_score" => 5, "units" => 1770.0},
         "refill" => %{"refill_percentage" => 2.645, "refill_score" => 15, "units" => 190.0}, "weekly_total" => 20 },
      "season1week2" => %{
         "pre" => %{"pre_percentage" => 1.4424444444444444, "pre_score" => 15, "units" => 791.0},
         "refill" => %{"refill_percentage" => 1.6199999999999999, "refill_score" => 15, "units" => 788.0}, "weekly_total" => 30 },
      "season1week3" => %{
         "pre" => %{"pre_percentage" => 0.8463703703703704, "pre_score" => 0, "units" => 2013.0},
         "refill" => %{"refill_percentage" => 1.1475, "refill_score" => 10, "units" => 280.0}, "weekly_total" => 10 }},
    model_after_bins: %{
      "season1week1" => %{"bin_audit" => %{"bin_percentage" => 82.5, "bin_score" => 5}, "weekly_total" => 5},
      "season1week2" => %{"bin_audit" => %{"bin_percentage" => 75.0, "bin_score" => 0}, "weekly_total" => 0}},
    model_after_all: %{
      "season1preseason" => %{
        "pre" => %{"pre_percentage" => 0.7383333333333334, "pre_score" => 0, "units" => 568.0},
        "refill" => %{"actual_units" => 2211.0}, "weekly_total" => 0},
      "season1week1" => %{
        "pre" => %{"pre_percentage" => 0.9774814814814816, "pre_score" => 5, "units" => 1770.0, "actual_units" => 5288.0,  "accuracy_score" => 0, "accuracy_percentage" => 0.3347201210287443},
        "refill" => %{"refill_percentage" => 2.645, "refill_score" => 15, "units" => 190.0, "actual_units" => 2641.0,  "accuracy_score" => 0, "accuracy_percentage" => 0.07194244604316546},
        "bin_audit" => %{"bin_percentage" => 82.5, "bin_score" => 5}, "weekly_total" => 25},
      "season1week2" => %{
        "pre" => %{"pre_percentage" => 1.4424444444444444, "pre_score" => 15, "units" => 791.0, "actual_units" => 6590.0,  "accuracy_score" => 0, "accuracy_percentage" => 0.12003034901365706},
        "refill" => %{"refill_percentage" => 1.6199999999999999, "refill_score" => 15, "units" => 788.0, "actual_units" => 3960.0,  "accuracy_score" => 0, "accuracy_percentage" => 0.198989898989899},
        "bin_audit" => %{"bin_percentage" => 75.0, "bin_score" => 0} , "weekly_total" => 30},
      "season1week3" => %{
        "refill" => %{"actual_units" => 3666.0, "refill_percentage" => 1.1475, "refill_score" => 10, "units" => 280.0, "accuracy_score" => 0, "accuracy_percentage" => 0.07637752318603383},
        "pre" => %{"actual_units" => 7732.0, "pre_percentage" => 0.8463703703703704, "pre_score" => 0, "units" => 2013.0, "accuracy_score" => 0, "accuracy_percentage" => 0.26034661148473875} , "weekly_total" => 10}

    },
      model_after_all_reduced: %{
        "season1preseason" => %{
          "pre" => %{"pre_percentage" => 0.7383333333333334, "pre_score" => 0, "units" => 568.0},
          "refill" => %{"actual_units" => 1149.72}, "weekly_total" => 0},
        "season1week1" => %{
          "pre" => %{"pre_percentage" => 0.9774814814814816, "pre_score" => 5, "units" => 1770.0, "actual_units" => 5288.0,  "accuracy_score" => 0, "accuracy_percentage" => 0.3347201210287443},
          "refill" => %{"refill_percentage" => 2.645, "refill_score" => 15, "units" => 190.0, "actual_units" => 1373.3200000000002,  "accuracy_score" => 0, "accuracy_percentage" => 0.1383508577753182},
          "bin_audit" => %{"bin_percentage" => 82.5, "bin_score" => 5}, "weekly_total" => 25},
        "season1week2" => %{
          "pre" => %{"pre_percentage" => 1.4424444444444444, "pre_score" => 15, "units" => 791.0, "actual_units" => 6590.0,  "accuracy_score" => 0, "accuracy_percentage" => 0.12003034901365706},
          "refill" => %{"refill_percentage" => 1.6199999999999999, "refill_score" => 15, "units" => 788.0, "actual_units" => 2059.2000000000003,  "accuracy_score" => 0, "accuracy_percentage" => 0.38267288267288263},
          "bin_audit" => %{"bin_percentage" => 75.0, "bin_score" => 0} , "weekly_total" => 30},
        "season1week3" => %{
          "refill" => %{"actual_units" => 1906.32, "refill_percentage" => 1.1475, "refill_score" => 10, "units" => 280.0, "accuracy_score" => 0, "accuracy_percentage" => 0.14687985228083428},
          "pre" => %{"actual_units" => 7732.0, "pre_percentage" => 0.8463703703703704, "pre_score" => 0, "units" => 2013.0, "accuracy_score" => 0, "accuracy_percentage" => 0.26034661148473875} , "weekly_total" => 10}

      },

      model_after_calc_bin: %{
        "season1preseason" => %{
          "pre" => %{"pre_percentage" => 0.7383333333333334, "pre_score" => 0, "units" => 568.0},
          "refill" => %{"actual_units" => 2211.0},
          "bin_audit" => %{"bin_percentage" => 0.0, "bin_score" => 0} , "weekly_total" => 0},
        "season1week1" => %{
          "pre" => %{"pre_percentage" => 0.9774814814814816, "pre_score" => 5, "units" => 1770.0, "actual_units" => 5288.0,  "accuracy_score" => 0, "accuracy_percentage" => 0.3347201210287443},
          "refill" => %{"refill_percentage" => 2.645, "refill_score" => 15, "units" => 190.0, "actual_units" => 2641.0,  "accuracy_score" => 0, "accuracy_percentage" => 0.07194244604316546},
          "bin_audit" => %{"bin_percentage" => 28.57142857142857, "bin_score" => 0} , "weekly_total" => 20},
        "season1week2" => %{
          "pre" => %{"pre_percentage" => 1.4424444444444444, "pre_score" => 15, "units" => 791.0, "actual_units" => 6590.0,  "accuracy_score" => 0, "accuracy_percentage" => 0.12003034901365706},
          "refill" => %{"refill_percentage" => 1.6199999999999999, "refill_score" => 15, "units" => 788.0, "actual_units" => 3960.0,  "accuracy_score" => 0, "accuracy_percentage" => 0.198989898989899},
          "bin_audit" => %{"bin_percentage" => 3000/70, "bin_score" => 0} , "weekly_total" => 30},
        "season1week3" => %{
          "refill" => %{"actual_units" => 3666.0, "refill_percentage" => 1.1475, "refill_score" => 10, "units" => 280.0, "accuracy_score" => 0, "accuracy_percentage" => 0.07637752318603383},
          "pre" => %{"actual_units" => 7732.0, "pre_percentage" => 0.8463703703703704, "pre_score" => 0, "units" => 2013.0, "accuracy_score" => 0, "accuracy_percentage" => 0.26034661148473875},
          "bin_audit" => %{"bin_percentage" => 14.285714285714285, "bin_score" => 0}, "weekly_total" => 10}

      },
        ]}
    end

    test "bin_audit_averaging works correctly" do
      bin_audit_list = [
        %{
          "BIN_COUNT_TOTAL"=>"20",
          "BIN_PERCENTAGE"=>"95.0",
          "DATE"=>"2017-06-27",
          "Dimension"=>"Factory",
          "District"=>"FS19",
          "NO_OF_AUDITS_PERFORMED"=>"1",
          "PASSED_BIN_COUNT"=>"19",
          "STORE"=>"67",
          "Store Name"=>"Estero",
          "Territory"=>"Southeast",
          "UPH Standard"=>"Factory EAS",
          "_BATCH_ID_"=>"20",
          "_BATCH_LAST_RUN_"=>"2017-07-05T21:07:49",
          "store_id"=>"67"
        },
        %{
          "BIN_COUNT_TOTAL"=>"40",
          "BIN_PERCENTAGE"=>"97.5",
          "DATE"=>"2017-06-29",
          "Dimension"=>"Factory",
          "District"=>"FS19",
          "NO_OF_AUDITS_PERFORMED"=>"2",
          "PASSED_BIN_COUNT"=>"39",
          "STORE"=>"67",
          "Store Name"=>"Estero",
          "Territory"=>"Southeast",
          "UPH Standard"=>"Factory EAS",
          "_BATCH_ID_"=>"20",
          "_BATCH_LAST_RUN_"=>"2017-07-05T21:07:49",
          "store_id"=>"67"
        },
        %{
          "BIN_COUNT_TOTAL"=>"36",
          "BIN_PERCENTAGE"=>"100.0",
          "DATE"=>"2017-07-01",
          "Dimension"=>"Factory",
          "District"=>"FS19",
          "NO_OF_AUDITS_PERFORMED"=>"2",
          "PASSED_BIN_COUNT"=>"36",
          "STORE"=>"67",
          "Store Name"=>"Estero",
          "Territory"=>"Southeast",
          "UPH Standard"=>"Factory EAS",
          "_BATCH_ID_"=>"20",
          "_BATCH_LAST_RUN_"=>"2017-07-05T21:07:49",
          "store_id"=>"67"
        }
      ]


      assert(Service.Stats.calc_bin_audit(bin_audit_list) == %{"bin_percentage" => 97.5, "bin_score" => 10})
    end

    test "play with actuals event", context do
      assert(Service.Stats.stats_reducer_recursive([context[:actuals_per_store]], %{}) == context[:model_after_actuals])
    end

    test "call on actuals event", context do
      assert(
      Service.Stats.call(
      [context[:actuals_per_store]], %State{ model: %{}, new_events: [] } )
      == %State{model: context[:model_after_actuals], new_events: []})
    end

    test "call on challenge event", context do
      assert(Service.Stats.call([context[:apa_event]], %State{model: %{}, new_events: []})==%State{model: context[:model_after_challenge], new_events: []})
    end

    test "call on bin audit event", context do
      assert(Service.Stats.call([context[:bin_audit_per_store]], %State{model: %{}, new_events: []})== %State{model: context[:model_after_bins], new_events: []})
    end

    test "call all events", context do
      assert(Service.Stats.call([context[:bin_audit_per_store], context[:apa_event], context[:actuals_per_store]], %State{model: %{}, new_events: []})==%State{model: context[:model_after_all], new_events: []})
    end

      test "call all events but with begining state", context do
        assert(Service.Stats.call([context[:apa_event], context[:actuals_per_store]], %State{model: context[:model_after_bins], new_events: []})==%State{model: context[:model_after_all], new_events: []})
      end

    test "call with reduced actuals store", context do
      assert(Service.Stats.call([context[:bin_audit_per_store], context[:apa_event], context[:reduced_actuals_per_store]], %State{model: %{}, new_events: []})==%State{model: context[:model_after_all_reduced], new_events: []})
    end

    test "call with needs a bin calc", context do
      assert(Service.Stats.call([context[:apa_event], context[:actuals_per_store_need_bin]], %State{model: %{}, new_events: []})==%State{model: context[:model_after_calc_bin], new_events: []})
    end


end
